;;; Test DIV, DDIV, RMD and DRMD

.import ../src/ladybug

.postfix PSEI, DSZI, DECI, INCI, WSIZE, LDI, STI, CMP  (semi-merged-postfix)
.postfix MASKL, MASKR, BITSUM, TST, SL, SR  (semi-merged-postfix)
.postfix #LIT (semi-merged-integer-literal)

LBL "TDIV"
WSIZE 64
SF 02
#LIT 0xfc
SL 56
MASKL 4   ; F000..
#LIT 4
DIV
SUB
FC? 00
SF 99

;; Signed remainder
CF 03     ; RMD does not affect carry
CF 04     ; RMD does not affect overflow
MASKL 12
MASKL 4
ENTERI
SR 08
RMD
FS? 00
SF 99
FC? 01
SF 99
FS? 03
SF 99
FS? 04
SF 99
SUB     ; subtract to get 0
FC? 00
SF 99
FS? 01
SF 99

;; unsigned remainder
CF 02
#LIT 14
#LIT 2
NEG
#LIT 56
CF 03     ; RMD does not affect carry
CF 04     ; RMD does not affect overflow
RMD
FS? 00
SF 99
FS? 01
SF 99
FS? 03
SF 99
FS? 04
SF 99
SUB
FC? 00
SF 99
FS? 01
SF 99


;; Signed double divide, negative operands in, result is positive
SF 02
#LIT 1234    ; marker to check that T remains
#LIT 100000  ; low part
NEG
#LIT 0       ; high part
NOT
#LIT 1000
NEG
DDIV
FS? 00
SF 99       ; upper part is 0, but whole result is non-zero
TST X
FC? 00
SF 99
CLXI
#LIT 100
SUB
FC? 00
SF 99
CLXI
#LIT 1234
SUB
FC? 00
SF 99

;; Signed double divide, negative result
#LIT 1234    ; marker to check that T remains
#LIT 100000  ; low part
NEG
#LIT 0       ; high part
NOT
#LIT 1000
DDIV
FS? 00
SF 99
TST X
FS? 00
SF 99
CLXI
#LIT 100
ADD
FC? 00
SF 99
CLXI
#LIT 1234
SUB
FC? 00
SF 99


;; Signed DRMD
#LIT  1234567
NEG
#LIT 0
NOT
#LIT  100
NEG
DRMD
FS? 00
SF 99
FC? 01
SF 99
#LIT 67
ADD
FC? 00
SF 99


;;; Unsigned DRMD
CF 02
MASKL 12
#LIT 0xf
#LIT 1000
DRMD
FS? 01
SF 99
#LIT 360
SUB
FC? 00
SF 99


;;; Tests regarding division by 0
MASKL 4
ENTERI
RMD      ; only high bits set
FC? 00
SF 99

SF 25    ; now for a real div by 0
MASKL 4
#LIT 0
RMD
FS?C 25
SF 99


;  DDIV with Z = 0x10:000000 (lower part, low half 0)
SF 02
MASKL 1
MASKL 64
#LIT 256
DDIV
RDNI
MASKL 9
SUB
FC? 00
SF 99

;  DDIV with Z = 00 (lower part), FFF in upper part
MASKL 64
#LIT 256
DDIV
RDNI
MASKL 8
SUB
FC? 00
SF 99


; DDIV with Z = 00 (lower part), 0xfe:000000 (upper part)
MASKL 7
MASKL 1
SR 1
DDIV
RDNI
MASKL 5
SUB
FC? 00
SF 99


; DIV two large numbers
CF 02
MASKL 2
ENTERI
SR 2
DIV
#LIT 4
SUB
FC? 00
SF 99

#LIT 0
MASKL 2
#LIT 1
DDIV
MASKL 2
SUB
FC? 00
SF 99
ADD
FC? 00
SF 99

SF 02
MASKL 2
ENTERI
SR 2
DIV
INCI X
FC? 00
SF 99

#LIT 0
MASKL 2
SR 2
#LIT 2
NEG
DDIV
#LIT 0xe8
SL 56
SUB
FC? 00
SF 99
ADD
FC? 00
SF 99

#LIT 0
MASKL 16
SR 2
#LIT 2
NEG
DDIV
#LIT 0xe0002
SL 44
SUB
FC? 00
SF 99
ADD
FC? 00
SF 99

; DDIV with size 56 is a bit interesting internally
WSIZE 56
MASKL 2
MASKL 56
LDI Y
SR 2
DDIV
FC? 03   ; should give carry as we have reminder
SF 99
FC? 01
SF 99
INCI X   ; result is -1, check both parts
FC? 00
SF 99
INCI Y
FC? 00
SF 99

XEQ 02

; DIV with word size smaller than 56
WSIZE 54
XEQ 02

; Overflow
WSIZE 16
MASKL 1
#LIT 1
NEG
DIV
FC? 04
SF 99
FC? 00
SF 99

RTN

LBL 02
MASKL 2
ENTERI
SR 2
DIV
FC? 03
SF 99
FC? 01
SF 99
INCI X
FC? 00
SF 99
END
